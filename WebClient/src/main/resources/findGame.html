<div class="container">
    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">Créer une partie</h3>
                </div>
                <div class="panel-body">
                    <form id="creation-form" class="form-horizontal">
                        <div class="form-group">
                            <label for="gameName" class="col-sm-2 control-label">Nom</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="gameName" placeholder="Nom de partie">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">Mot de passe</label>
                            <div class="col-sm-10">
                                <input type="password" class="form-control" id="password"
                                       placeholder="Mot de passe de la salle (facultatif)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="villagers" class="col-sm-2 control-label">Villageois</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control" id="villagers"
                                       placeholder="Nombre de villageois">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="wolves" class="col-sm-2 control-label">Loup Garous</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control" id="wolves" placeholder="Nombre de loups">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="characters" class="col-sm-2 control-label">Nom</label>
                            <div class="col-sm-10">
                                <select id="characters" class="form-control" multiple style="width: 100%;">
                                    <option value="MEDIUM">Voyante</option>
                                    <option value="HUNTER">Chasseur</option>
                                    <option value="CUPIDON">Cupidon</option>
                                    <option value="WITCH">Sorcière</option>
                                    <option value="LITTLE_GIRL">Petite fille</option>
                                    <option value="THIEF">Voleur</option>
                                    <option value="SAVER">Salvateur</option>
                                    <option value="WHITE_WOLF">Loup Garou Blanc</option>
                                    <option value="ANCIENT">Ancien</option>
                                    <option value="ANGEL">Ange</option>
                                    <option value="IDIOT">Idiot du vilage</option>
                                    <option value="GREAT_BAD_WOLF">Grand méchant loup</option>
                                    <option value="SAVAGE_KID">Enfant Sauvage</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-sm-12">
                                <button type="submit" class="btn btn-default" style="width: 100%;">Créer la partie
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">Rejoindre une partie</h3>
                </div>
                <div class="panel-body">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Host</th>
                            <th>Joueurs</th>
                            <th>Êtat</th>
                        </tr>
                        </thead>

                        <tbody id="table-content">
                        <tr>
                            <td colspan="4">Aucun contenu pour le moment.</td>
                        </tr>
                        </tbody>
                    </table>
                    <button class="btn btn-primary" style="width: 100%" id="refresh-btn">Rafraichir</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function create() {
        var name = $("#gameName").val();
        var villagers = parseInt($("#villagers").val(), 10);
        var wolves = parseInt($("#wolves").val(), 10);

        if (villagers < 0) {
            // TODO : Cleaner stuff
            alert("Merci d'indiquer un nombre de villageois positif ou nul.");
            return;
        }

        if (wolves < 1) {
            alert("Il doit y avoir au moins un loup !");
            return;
        }

        var roles = $("#characters").val();
        var maxPl = villagers + wolves + roles.length;
        if ($.inArray("THIEF", roles) >= 0)
            maxPl -= 2;

        console.log("Max Players : " + maxPl + ", composed of " + villagers + " villagers, " + wolves + " wolves and " + roles.length + " additional roles. Thief ? " + $.inArray("THIEF", roles))

        if (maxPl > 70) {
            alert("Il est impossible d'accepter plus de 70 joueurs dans une même partie.");
            return;
        }

        if (maxPl < 2) {
            alert("Il faut minimum deux joueurs dans une partie.");
            return;
        }

        var i = 0;
        while (i < wolves) {
            roles.push("WOLF");
            i += 1;
        }

        var packet = {
            packetId: 0xA1,
            name: name,
            players: maxPl,
            characters: roles
        };

        var password = $("#password").val();
        if (password != "") {
            packet.password = sha256(password);
        }

        handler.sendPacket(packet);
    }

    function doRefresh() {
        handler.sendPacket({
            packetId: 0xA4
        });
    }

    gameRefreshHandler = function () {
        var html = "";

        for (var gameId in games) {
            var game = games[gameId];
            html += "<tr>";
            html += "<td><a onclick='join(" + gameId + ")' href='#'>" + game.gameName + "</a></td>";
            html += "<td>" + game.hoster + "</td>";
            html += "<td>" + game.currentPlayers + " / " + game.maxPlayers + "</td>";
            html += "<td>" + gameState[game.state] + "</td>";
            html += "</td>";
        }

        if (html === "") {
            html = "<tr> <td colspan=\"4\">Aucun contenu pour le moment.</td> </tr>";
        }

        $("#table-content").html(html);
    };

    function join(gameId) {
        console.log("Joining game " + gameId);
        var game = games[gameId];
        if (typeof game !== "undefined") {
            var packet = {
                gameId: gameId,
                packetId: 0xA2
            };

            if (game.hasPassword) {
                packet.password = prompt("Mot de passe de la partie");
            }

            handler.sendPacket(packet);
        }
    }

    $(document).ready(function () {
        $('#creation-form').on('submit', function (e) {
            e.preventDefault();
            create();
        });

        $("#refresh-btn").on('click', function (e) {
            doRefresh();
        });

        gameRefreshHandler();
    });
</script>